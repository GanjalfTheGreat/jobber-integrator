{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<h1>Price Sync</h1>
<p class="muted">Sync your wholesaler CSV costs to Jobber Products &amp; Services.</p>

{% if error %}
<div class="card" style="border-left: 4px solid var(--color-critical);">
    <p><strong>Something went wrong:</strong> {{ error }}{% if error_message %} – {{ error_message }}{% endif %}</p>
    <p class="muted">Check that JOBBER_CLIENT_ID and JOBBER_CLIENT_SECRET are set in .env and that your app’s OAuth Callback URL in the Jobber Developer Center matches <code>{{ base_url }}/oauth/callback</code>.</p>
</div>
{% endif %}

<div class="card">
    {% if connected %}
    <p><strong>Connected</strong> to Jobber ({{ jobber_account_name or "your account" }}).</p>
    <p class="muted">Upload a CSV to update product costs.</p>
    <a href="/disconnect" class="btn btn--subtle" style="margin-top: 0.5rem;">Disconnect</a>

    <div class="form-group" style="margin-top: var(--space-large);">
        <form id="sync-form" enctype="multipart/form-data">
            <label for="csv-file">CSV file</label>
            <input type="file" id="csv-file" name="file" accept=".csv" required>
            <div class="form-group" style="margin-top: var(--space-small);">
                <label style="display: flex; align-items: center; gap: var(--space-small); cursor: pointer;">
                    <input type="checkbox" id="only-increase-cost" name="only_increase_cost" value="true">
                    <span>Only update costs when the new price is higher (never lower)</span>
                </label>
            </div>
            <div class="form-group" style="margin-top: var(--space-small);">
                <label style="display: flex; align-items: center; gap: var(--space-small); cursor: pointer;">
                    <input type="checkbox" id="fuzzy-match" name="fuzzy_match" value="true">
                    <span>Fuzzy matching (match similar product names; use with care and review results)</span>
                </label>
            </div>
            <div class="form-group" style="margin-top: var(--space-small);">
                <label for="markup-percent">Markup % (set unit price = cost × (1 + markup); 0 = cost only)</label>
                <input type="number" id="markup-percent" name="markup_percent" min="0" max="500" step="0.5" value="" placeholder="0" style="width: 6rem;">
            </div>
            <button type="button" class="btn btn--subtle" id="preview-btn" style="margin-top: var(--space-base); margin-right: var(--space-small);">Preview</button>
            <button type="submit" class="btn" id="sync-btn" style="margin-top: var(--space-base);">Sync now</button>
        </form>
        <p id="sync-status" class="muted" style="margin-top: var(--space-small); display: none;">Syncing…</p>
        <div id="preview-result" class="card sync-result" style="display: none; margin-top: var(--space-base);" role="status"></div>
        <div id="sync-result" class="sync-result" style="display: none;" role="status"></div>
    </div>
    {% else %}
    <p>Connect your Jobber account to get started.</p>
    <p class="muted">You’ll be sent to Jobber to authorize this app, then returned here.</p>
    <a href="/connect" class="btn">Connect to Jobber</a>
    {% endif %}
</div>

<div class="card">
    <h2>CSV format</h2>
    <p class="muted">Your file should have columns: <code>Part_Num</code> (product name in Jobber) and <code>Trade_Cost</code> (unit cost). An optional <code>Description</code> column is shown in the preview to help you confirm which product is which.</p>
</div>

{% if connected %}
<script>
(function() {
    var form = document.getElementById('sync-form');
    var fileInput = document.getElementById('csv-file');
    var btn = document.getElementById('sync-btn');
    var previewBtn = document.getElementById('preview-btn');
    var status = document.getElementById('sync-status');
    var resultEl = document.getElementById('sync-result');
    var previewEl = document.getElementById('preview-result');
    if (!form) return;

    function doSync(fd, then) {
        btn.disabled = true;
        status.style.display = 'block';
        resultEl.style.display = 'none';
        resultEl.className = 'sync-result';
        resultEl.textContent = '';
        fetch('/api/sync', { method: 'POST', body: fd, credentials: 'same-origin' })
            .then(function(r) { return r.json().then(function(d) { return { status: r.status, data: d }; }); })
            .then(then)
            .catch(function(err) {
                status.style.display = 'none';
                btn.disabled = false;
                resultEl.style.display = 'block';
                resultEl.className = 'sync-result error';
                resultEl.textContent = 'Request failed: ' + (err.message || 'Please try again.');
            });
    }

    function showSyncResult(o) {
        status.style.display = 'none';
        btn.disabled = false;
        resultEl.style.display = 'block';
        var d = o.data;
        if (d.error && o.status === 403) {
            resultEl.className = 'sync-result error';
            resultEl.innerHTML = '<strong>Error:</strong> ' + (d.error || 'Not connected.') + ' <a href="/connect">Connect to Jobber</a>';
            return;
        }
        if (d.error && d.updated === 0 && (!d.skus_not_found || !d.skus_not_found.length)) {
            resultEl.className = 'sync-result error';
            resultEl.textContent = d.error;
            return;
        }
        resultEl.className = 'sync-result success';
        var updated = d.updated || 0, skipped = d.skipped_protected || 0, nf = (d.skus_not_found && d.skus_not_found.length) ? d.skus_not_found.length : 0, fuzzy = d.fuzzy_matched_count || 0, markup = d.markup_percent || 0;
        var parts = [];
        if (updated > 0) {
            if (markup > 0) parts.push(updated + ' cost(s) and unit prices updated in Jobber (unit price = cost + ' + markup + '% markup).');
            else parts.push(updated + ' cost(s) updated in Jobber.');
        }
        if (skipped > 0) parts.push(skipped + ' skipped (new cost was not higher than current).');
        if (fuzzy > 0) parts.push(fuzzy + ' matched using fuzzy matching.');
        if (nf > 0) parts.push(nf + ' item(s) from your file didn\'t match any product in Jobber.');
        if (parts.length === 0) parts.push('No changes made.');
        var msg = parts.join(' ');
        if (nf > 0) {
            resultEl.innerHTML = '<p>' + msg + '</p><p class="muted" style="margin-top: var(--space-small); margin-bottom: var(--space-smaller);">Unmatched names from your CSV:</p><div class="skus-list">' + d.skus_not_found.map(function(s) { return '<span>' + s + '</span>'; }).join(', ') + '</div>';
        } else {
            resultEl.innerHTML = '<p>' + msg + '</p>';
        }
        if (d.error) resultEl.innerHTML = resultEl.innerHTML + '<p class="muted" style="margin-top:8px;">' + d.error + '</p>';
    }

    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
        if (!fileInput.files.length) return;
        var fd = new FormData();
        fd.append('file', fileInput.files[0]);
        if (document.getElementById('fuzzy-match').checked) fd.append('fuzzy_match', 'true');
        previewEl.style.display = 'none';
            previewEl.innerHTML = '<p class="muted">Loading preview…</p>';
            previewEl.style.display = 'block';
            fetch('/api/sync/preview', { method: 'POST', body: fd, credentials: 'same-origin' })
                .then(function(r) { return r.json().then(function(d) { return { status: r.status, data: d }; }); })
                .then(function(o) {
                    var d = o.data;
                    if (d.error && o.status === 403) {
                        previewEl.innerHTML = '<p class="sync-result error"><strong>Error:</strong> ' + (d.error || 'Not connected.') + ' <a href="/connect">Connect to Jobber</a></p>';
                        return;
                    }
                    if (d.error && !d.increases && !d.decreases && !d.unchanged && (!d.skus_not_found || !d.skus_not_found.length)) {
                        previewEl.innerHTML = '<p class="sync-result error">' + (d.error || 'Preview failed.') + '</p>';
                        return;
                    }
                    var inc = d.increases || 0, dec = d.decreases || 0, unc = d.unchanged || 0, nf = (d.skus_not_found && d.skus_not_found.length) ? d.skus_not_found.length : 0, fuzzy = d.fuzzy_matched_count || 0;
                    var msg = 'This will <strong>increase</strong> ' + inc + ' cost(s), <strong>decrease</strong> ' + dec + ', and leave ' + unc + ' unchanged in Jobber.';
                    if (fuzzy) msg += ' ' + fuzzy + ' match(es) use fuzzy matching.';
                    if (nf) msg += ' ' + nf + ' item(s) from your file have no matching product in Jobber and will be skipped.';
                    var markupInput = document.getElementById('markup-percent');
                    if (markupInput && markupInput.value !== '' && parseFloat(markupInput.value) > 0) msg += ' <strong>Unit prices will be set to cost + ' + markupInput.value + '% markup</strong> for each product updated.';
                    var detailHtml = '';
                    function fmtRow(item) {
                        var line = item.part_num + ' — CSV ' + item.csv_cost + ', current ' + item.current_cost;
                        var sub = [];
                        if (item.description) sub.push(item.description);
                        if (item.jobber_name && item.jobber_name !== item.part_num) sub.push('Jobber: ' + item.jobber_name);
                        if (sub.length) line += '<br><span class="muted" style="font-size: 0.9em;">' + sub.join(' · ') + '</span>';
                        return line;
                    }
                    if (d.increases_detail && d.increases_detail.length) {
                        detailHtml += '<p class="muted" style="margin-top: var(--space-small); margin-bottom: var(--space-smaller);"><strong>Increases:</strong></p><ul class="skus-list" style="margin-top: 0;">' + d.increases_detail.map(function(it) { return '<li>' + fmtRow(it) + '</li>'; }).join('') + '</ul>';
                    }
                    if (d.decreases_detail && d.decreases_detail.length) {
                        detailHtml += '<p class="muted" style="margin-top: var(--space-small); margin-bottom: var(--space-smaller);"><strong>Decreases:</strong></p><ul class="skus-list" style="margin-top: 0;">' + d.decreases_detail.map(function(it) { return '<li>' + fmtRow(it) + '</li>'; }).join('') + '</ul>';
                    }
                    if (d.unchanged_detail && d.unchanged_detail.length) {
                        detailHtml += '<p class="muted" style="margin-top: var(--space-small); margin-bottom: var(--space-smaller);"><strong>Unchanged:</strong></p><ul class="skus-list" style="margin-top: 0;">' + d.unchanged_detail.map(function(it) { return '<li>' + fmtRow(it) + '</li>'; }).join('') + '</ul>';
                    }
                    previewEl.innerHTML = '<p>' + msg + '</p>' + detailHtml + '<p style="margin-top: var(--space-base);"><button type="button" class="btn" id="apply-btn">Apply changes</button> <button type="button" class="btn btn--subtle" id="preview-cancel-btn">Cancel</button></p>';
                    document.getElementById('preview-cancel-btn').onclick = function() { previewEl.style.display = 'none'; };
                    document.getElementById('apply-btn').onclick = function() {
                        var applyFd = new FormData();
                        applyFd.append('file', fileInput.files[0]);
                        if (document.getElementById('only-increase-cost').checked) applyFd.append('only_increase_cost', 'true');
                        if (document.getElementById('fuzzy-match').checked) applyFd.append('fuzzy_match', 'true');
                        var markupInput = document.getElementById('markup-percent');
                        if (markupInput && markupInput.value !== '' && parseFloat(markupInput.value) >= 0) applyFd.append('markup_percent', markupInput.value);
                        previewEl.style.display = 'none';
                        doSync(applyFd, function(o) { showSyncResult(o); });
                    };
                })
                .catch(function(err) {
                    previewEl.innerHTML = '<p class="sync-result error">Preview failed: ' + (err.message || 'Please try again.') + '</p>';
                });
        });
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (!fileInput.files.length) return;
        var fd = new FormData();
        fd.append('file', fileInput.files[0]);
        if (document.getElementById('only-increase-cost').checked) fd.append('only_increase_cost', 'true');
        if (document.getElementById('fuzzy-match').checked) fd.append('fuzzy_match', 'true');
        var markupInput = document.getElementById('markup-percent');
        if (markupInput && markupInput.value !== '' && parseFloat(markupInput.value) >= 0) fd.append('markup_percent', markupInput.value);
        doSync(fd, function(o) { showSyncResult(o); });
    });
})();
</script>
{% endif %}

<p class="muted"><a href="{{ base_url }}/health">Health check</a></p>
{% endblock %}
